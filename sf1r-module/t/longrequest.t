# vi:filetype=perl

use lib 'lib';
use Test::Nginx::Socket;

our $config = <<'_EOC_';
    location /sf1r/ {
        rewrite ^/sf1r(/.*)$ $1 break;
        sf1r;
    }
_EOC_

plan tests => 1 * blocks();

no_shuffle();
run_tests();

__DATA__

=== TEST 1: GET documents/search
--- config eval: $::config
--- request
GET /sf1r/documents/search
{"search":{"ranking_model":"plm","log_keywords":false,"keywords":"*","analyzer":{"apply_la":true,"use_synonym_extension":true,"use_original_keyword":false},"group_label":[{"value":["数码"],"property":"Category"}],"in":[{"property":"Title"},{"property":"Category"},{"property":"Source"}]},"limit":20,"sort":[{"property":"_ctr","order":"DESC"}],"header":{"check_time":"true"},"remove_duplicated_result":false,"collection":"b5mp","offset":0,"conditions":[],"select":[{"summary":false,"highlight":true,"property":"DOCID","snippet":true},{"summary":false,"highlight":true,"property":"Title","snippet":true},{"summary":false,"highlight":true,"property":"Url","snippet":true},{"summary":false,"highlight":true,"property":"DATE","snippet":true},{"summary":false,"highlight":true,"property":"Content","snippet":true},{"summary":false,"highlight":true,"property":"Price","snippet":true},{"summary":false,"highlight":true,"property":"Picture","snippet":true},{"summary":false,"highlight":true,"property":"Category","snippet":true},{"summary":false,"highlight":true,"property":"Source","snippet":true},{"summary":false,"highlight":true,"property":"itemcount","snippet":true}]}


=== TEST 2: POST documents/search
--- config eval: $::config
--- request
POST /sf1r/documents/search
{"search":{"ranking_model":"plm","log_keywords":false,"keywords":"电脑","analyzer":{"apply_la":true,"use_synonym_extension":true,"use_original_keyword":false},"group_label":[],"in":[{"property":"Title"},{"property":"Category"},{"property":"MerchantName"}]},"group":[{"property":"Source","range":false},{"property":"Price","range":true},{"property":"SubCategory","range":false},{"property":"MerchantArea","range":false},{"property":"Category","range":false}],"limit":0,"sort":[],"header":{"check_time":"true"},"remove_duplicated_result":false,"collection":"tuana","offset":0,"conditions":[],"select":[{"summary":false,"highlight":true,"property":"DOCID","snippet":true},{"summary":false,"highlight":true,"property":"Title","snippet":true},{"summary":false,"highlight":true,"property":"Category","snippet":true},{"summary":false,"highlight":true,"property":"Picture","snippet":true},{"summary":false,"highlight":true,"property":"Sales","snippet":true},{"summary":false,"highlight":true,"property":"SubCategory","snippet":true},{"summary":false,"highlight":true,"property":"MerchantArea","snippet":true},{"summary":false,"highlight":true,"property":"MerchantAddr","snippet":true},{"summary":false,"highlight":true,"property":"TimeBegin","snippet":true},{"summary":false,"highlight":true,"property":"MerchantName","snippet":true},{"summary":false,"highlight":true,"property":"City","snippet":true},{"summary":false,"highlight":true,"property":"Source","snippet":true},{"summary":false,"highlight":true,"property":"PriceOrign","snippet":true},{"summary":false,"highlight":true,"property":"Url","snippet":true},{"summary":false,"highlight":true,"property":"SourceUrl","snippet":true},{"summary":false,"highlight":true,"property":"Price","snippet":true},{"summary":false,"highlight":true,"property":"Discount","snippet":true},{"summary":false,"highlight":true,"property":"TimeEnd","snippet":true}]}


=== TEST 3: POST documents/search (file buffer)
--- config eval: $::config
--- request
POST /sf1r/documents/search
{"search":{"ranking_model":"plm","log_keywords":false,"keywords":"电脑","analyzer":{"apply_la":true,"use_synonym_extension":true,"use_original_keyword":false},"group_label":[],"in":[{"property":"Title"},{"property":"Category"},{"property":"MerchantName"}]},"group":[{"property":"Source","range":false},{"property":"Price","range":true},{"property":"SubCategory","range":false},{"property":"MerchantArea","range":false},{"property":"Category","range":false}],"limit":0,"sort":[],"header":{"check_time":"true"},"remove_duplicated_result":false,"collection":"tuana","offset":0,"conditions":[],"select":[{"summary":false,"highlight":true,"property":"DOCID","snippet":true},{"summary":false,"highlight":true,"property":"Title","snippet":true},{"summary":false,"highlight":true,"property":"Category","snippet":true},{"summary":false,"highlight":true,"property":"Picture","snippet":true},{"summary":false,"highlight":true,"property":"Sales","snippet":true},{"summary":false,"highlight":true,"property":"SubCategory","snippet":true},{"summary":false,"highlight":true,"property":"MerchantArea","snippet":true},{"summary":false,"highlight":true,"property":"MerchantAddr","snippet":true},{"summary":false,"highlight":true,"property":"TimeBegin","snippet":true},{"summary":false,"highlight":true,"property":"MerchantName","snippet":true},{"summary":false,"highlight":true,"property":"City","snippet":true},{"summary":false,"highlight":true,"property":"Source","snippet":true},{"summary":false,"highlight":true,"property":"PriceOrign","snippet":true},{"summary":false,"highlight":true,"property":"Url","snippet":true},{"summary":false,"highlight":true,"property":"SourceUrl","snippet":true},{"summary":false,"highlight":true,"property":"Price","snippet":true},{"summary":false,"highlight":true,"property":"Discount","snippet":true},{"summary":false,"highlight":true,"property":"TimeEnd","snippet":true},{"summary":false,"highlight":true,"property":"DOCID","snippet":true},{"summary":false,"highlight":true,"property":"Title","snippet":true},{"summary":false,"highlight":true,"property":"Category","snippet":true},{"summary":false,"highlight":true,"property":"Picture","snippet":true},{"summary":false,"highlight":true,"property":"Sales","snippet":true},{"summary":false,"highlight":true,"property":"SubCategory","snippet":true},{"summary":false,"highlight":true,"property":"MerchantArea","snippet":true},{"summary":false,"highlight":true,"property":"MerchantAddr","snippet":true},{"summary":false,"highlight":true,"property":"TimeBegin","snippet":true},{"summary":false,"highlight":true,"property":"MerchantName","snippet":true},{"summary":false,"highlight":true,"property":"City","snippet":true},{"summary":false,"highlight":true,"property":"Source","snippet":true},{"summary":false,"highlight":true,"property":"PriceOrign","snippet":true},{"summary":false,"highlight":true,"property":"Url","snippet":true},{"summary":false,"highlight":true,"property":"SourceUrl","snippet":true},{"summary":false,"highlight":true,"property":"Price","snippet":true},{"summary":false,"highlight":true,"property":"Discount","snippet":true},{"summary":false,"highlight":true,"property":"TimeEnd","snippet":true},{"summary":false,"highlight":true,"property":"DOCID","snippet":true},{"summary":false,"highlight":true,"property":"Title","snippet":true},{"summary":false,"highlight":true,"property":"Category","snippet":true},{"summary":false,"highlight":true,"property":"Picture","snippet":true},{"summary":false,"highlight":true,"property":"Sales","snippet":true},{"summary":false,"highlight":true,"property":"SubCategory","snippet":true},{"summary":false,"highlight":true,"property":"MerchantArea","snippet":true},{"summary":false,"highlight":true,"property":"MerchantAddr","snippet":true},{"summary":false,"highlight":true,"property":"TimeBegin","snippet":true},{"summary":false,"highlight":true,"property":"MerchantName","snippet":true},{"summary":false,"highlight":true,"property":"City","snippet":true},{"summary":false,"highlight":true,"property":"Source","snippet":true},{"summary":false,"highlight":true,"property":"PriceOrign","snippet":true},{"summary":false,"highlight":true,"property":"Url","snippet":true},{"summary":false,"highlight":true,"property":"SourceUrl","snippet":true},{"summary":false,"highlight":true,"property":"Price","snippet":true},{"summary":false,"highlight":true,"property":"Discount","snippet":true},{"summary":false,"highlight":true,"property":"TimeEnd","snippet":true},{"summary":false,"highlight":true,"property":"DOCID","snippet":true},{"summary":false,"highlight":true,"property":"Title","snippet":true},{"summary":false,"highlight":true,"property":"Category","snippet":true},{"summary":false,"highlight":true,"property":"Picture","snippet":true},{"summary":false,"highlight":true,"property":"Sales","snippet":true},{"summary":false,"highlight":true,"property":"SubCategory","snippet":true},{"summary":false,"highlight":true,"property":"MerchantArea","snippet":true},{"summary":false,"highlight":true,"property":"MerchantAddr","snippet":true},{"summary":false,"highlight":true,"property":"TimeBegin","snippet":true},{"summary":false,"highlight":true,"property":"MerchantName","snippet":true},{"summary":false,"highlight":true,"property":"City","snippet":true},{"summary":false,"highlight":true,"property":"Source","snippet":true},{"summary":false,"highlight":true,"property":"PriceOrign","snippet":true},{"summary":false,"highlight":true,"property":"Url","snippet":true},{"summary":false,"highlight":true,"property":"SourceUrl","snippet":true},{"summary":false,"highlight":true,"property":"Price","snippet":true},{"summary":false,"highlight":true,"property":"Discount","snippet":true},{"summary":false,"highlight":true,"property":"TimeEnd","snippet":true},{"summary":false,"highlight":true,"property":"DOCID","snippet":true},{"summary":false,"highlight":true,"property":"Title","snippet":true},{"summary":false,"highlight":true,"property":"Category","snippet":true},{"summary":false,"highlight":true,"property":"Picture","snippet":true},{"summary":false,"highlight":true,"property":"Sales","snippet":true},{"summary":false,"highlight":true,"property":"SubCategory","snippet":true},{"summary":false,"highlight":true,"property":"MerchantArea","snippet":true},{"summary":false,"highlight":true,"property":"MerchantAddr","snippet":true},{"summary":false,"highlight":true,"property":"TimeBegin","snippet":true},{"summary":false,"highlight":true,"property":"MerchantName","snippet":true},{"summary":false,"highlight":true,"property":"City","snippet":true},{"summary":false,"highlight":true,"property":"Source","snippet":true},{"summary":false,"highlight":true,"property":"PriceOrign","snippet":true},{"summary":false,"highlight":true,"property":"Url","snippet":true},{"summary":false,"highlight":true,"property":"SourceUrl","snippet":true},{"summary":false,"highlight":true,"property":"Price","snippet":true},{"summary":false,"highlight":true,"property":"Discount","snippet":true},{"summary":false,"highlight":true,"property":"TimeEnd","snippet":true},{"summary":false,"highlight":true,"property":"DOCID","snippet":true},{"summary":false,"highlight":true,"property":"Title","snippet":true},{"summary":false,"highlight":true,"property":"Category","snippet":true},{"summary":false,"highlight":true,"property":"Picture","snippet":true},{"summary":false,"highlight":true,"property":"Sales","snippet":true},{"summary":false,"highlight":true,"property":"SubCategory","snippet":true},{"summary":false,"highlight":true,"property":"MerchantArea","snippet":true},{"summary":false,"highlight":true,"property":"MerchantAddr","snippet":true},{"summary":false,"highlight":true,"property":"TimeBegin","snippet":true},{"summary":false,"highlight":true,"property":"MerchantName","snippet":true},{"summary":false,"highlight":true,"property":"City","snippet":true},{"summary":false,"highlight":true,"property":"Source","snippet":true},{"summary":false,"highlight":true,"property":"PriceOrign","snippet":true},{"summary":false,"highlight":true,"property":"Url","snippet":true},{"summary":false,"highlight":true,"property":"SourceUrl","snippet":true},{"summary":false,"highlight":true,"property":"Price","snippet":true},{"summary":false,"highlight":true,"property":"Discount","snippet":true},{"summary":false,"highlight":true,"property":"TimeEnd","snippet":true},{"summary":false,"highlight":true,"property":"DOCID","snippet":true},{"summary":false,"highlight":true,"property":"Title","snippet":true},{"summary":false,"highlight":true,"property":"Category","snippet":true},{"summary":false,"highlight":true,"property":"Picture","snippet":true},{"summary":false,"highlight":true,"property":"Sales","snippet":true},{"summary":false,"highlight":true,"property":"SubCategory","snippet":true},{"summary":false,"highlight":true,"property":"MerchantArea","snippet":true},{"summary":false,"highlight":true,"property":"MerchantAddr","snippet":true},{"summary":false,"highlight":true,"property":"TimeBegin","snippet":true},{"summary":false,"highlight":true,"property":"MerchantName","snippet":true},{"summary":false,"highlight":true,"property":"City","snippet":true},{"summary":false,"highlight":true,"property":"Source","snippet":true},{"summary":false,"highlight":true,"property":"PriceOrign","snippet":true},{"summary":false,"highlight":true,"property":"Url","snippet":true},{"summary":false,"highlight":true,"property":"SourceUrl","snippet":true},{"summary":false,"highlight":true,"property":"Price","snippet":true},{"summary":false,"highlight":true,"property":"Discount","snippet":true},{"summary":false,"highlight":true,"property":"TimeEnd","snippet":true},{"summary":false,"highlight":true,"property":"DOCID","snippet":true},{"summary":false,"highlight":true,"property":"Title","snippet":true},{"summary":false,"highlight":true,"property":"Category","snippet":true},{"summary":false,"highlight":true,"property":"Picture","snippet":true},{"summary":false,"highlight":true,"property":"Sales","snippet":true},{"summary":false,"highlight":true,"property":"SubCategory","snippet":true},{"summary":false,"highlight":true,"property":"MerchantArea","snippet":true},{"summary":false,"highlight":true,"property":"MerchantAddr","snippet":true},{"summary":false,"highlight":true,"property":"TimeBegin","snippet":true},{"summary":false,"highlight":true,"property":"MerchantName","snippet":true},{"summary":false,"highlight":true,"property":"City","snippet":true},{"summary":false,"highlight":true,"property":"Source","snippet":true},{"summary":false,"highlight":true,"property":"PriceOrign","snippet":true},{"summary":false,"highlight":true,"property":"Url","snippet":true},{"summary":false,"highlight":true,"property":"SourceUrl","snippet":true},{"summary":false,"highlight":true,"property":"Price","snippet":true},{"summary":false,"highlight":true,"property":"Discount","snippet":true},{"summary":false,"highlight":true,"property":"TimeEnd","snippet":true},{"summary":false,"highlight":true,"property":"DOCID","snippet":true},{"summary":false,"highlight":true,"property":"Title","snippet":true},{"summary":false,"highlight":true,"property":"Category","snippet":true},{"summary":false,"highlight":true,"property":"Picture","snippet":true},{"summary":false,"highlight":true,"property":"Sales","snippet":true},{"summary":false,"highlight":true,"property":"SubCategory","snippet":true},{"summary":false,"highlight":true,"property":"MerchantArea","snippet":true},{"summary":false,"highlight":true,"property":"MerchantAddr","snippet":true},{"summary":false,"highlight":true,"property":"TimeBegin","snippet":true},{"summary":false,"highlight":true,"property":"MerchantName","snippet":true},{"summary":false,"highlight":true,"property":"City","snippet":true},{"summary":false,"highlight":true,"property":"Source","snippet":true},{"summary":false,"highlight":true,"property":"PriceOrign","snippet":true},{"summary":false,"highlight":true,"property":"Url","snippet":true},{"summary":false,"highlight":true,"property":"SourceUrl","snippet":true},{"summary":false,"highlight":true,"property":"Price","snippet":true},{"summary":false,"highlight":true,"property":"Discount","snippet":true},{"summary":false,"highlight":true,"property":"TimeEnd","snippet":true},{"summary":false,"highlight":true,"property":"DOCID","snippet":true},{"summary":false,"highlight":true,"property":"Title","snippet":true},{"summary":false,"highlight":true,"property":"Category","snippet":true},{"summary":false,"highlight":true,"property":"Picture","snippet":true},{"summary":false,"highlight":true,"property":"Sales","snippet":true},{"summary":false,"highlight":true,"property":"SubCategory","snippet":true},{"summary":false,"highlight":true,"property":"MerchantArea","snippet":true},{"summary":false,"highlight":true,"property":"MerchantAddr","snippet":true},{"summary":false,"highlight":true,"property":"TimeBegin","snippet":true},{"summary":false,"highlight":true,"property":"MerchantName","snippet":true},{"summary":false,"highlight":true,"property":"City","snippet":true},{"summary":false,"highlight":true,"property":"Source","snippet":true},{"summary":false,"highlight":true,"property":"PriceOrign","snippet":true},{"summary":false,"highlight":true,"property":"Url","snippet":true},{"summary":false,"highlight":true,"property":"SourceUrl","snippet":true},{"summary":false,"highlight":true,"property":"Price","snippet":true},{"summary":false,"highlight":true,"property":"Discount","snippet":true},{"summary":false,"highlight":true,"property":"TimeEnd","snippet":true},{"summary":false,"highlight":true,"property":"DOCID","snippet":true},{"summary":false,"highlight":true,"property":"Title","snippet":true},{"summary":false,"highlight":true,"property":"Category","snippet":true},{"summary":false,"highlight":true,"property":"Picture","snippet":true},{"summary":false,"highlight":true,"property":"Sales","snippet":true},{"summary":false,"highlight":true,"property":"SubCategory","snippet":true},{"summary":false,"highlight":true,"property":"MerchantArea","snippet":true},{"summary":false,"highlight":true,"property":"MerchantAddr","snippet":true},{"summary":false,"highlight":true,"property":"TimeBegin","snippet":true},{"summary":false,"highlight":true,"property":"MerchantName","snippet":true},{"summary":false,"highlight":true,"property":"City","snippet":true},{"summary":false,"highlight":true,"property":"Source","snippet":true},{"summary":false,"highlight":true,"property":"PriceOrign","snippet":true},{"summary":false,"highlight":true,"property":"Url","snippet":true},{"summary":false,"highlight":true,"property":"SourceUrl","snippet":true},{"summary":false,"highlight":true,"property":"Price","snippet":true},{"summary":false,"highlight":true,"property":"Discount","snippet":true},{"summary":false,"highlight":true,"property":"TimeEnd","snippet":true},{"summary":false,"highlight":true,"property":"DOCID","snippet":true},{"summary":false,"highlight":true,"property":"Title","snippet":true},{"summary":false,"highlight":true,"property":"Category","snippet":true},{"summary":false,"highlight":true,"property":"Picture","snippet":true},{"summary":false,"highlight":true,"property":"Sales","snippet":true},{"summary":false,"highlight":true,"property":"SubCategory","snippet":true},{"summary":false,"highlight":true,"property":"MerchantArea","snippet":true},{"summary":false,"highlight":true,"property":"MerchantAddr","snippet":true},{"summary":false,"highlight":true,"property":"TimeBegin","snippet":true},{"summary":false,"highlight":true,"property":"MerchantName","snippet":true},{"summary":false,"highlight":true,"property":"City","snippet":true},{"summary":false,"highlight":true,"property":"Source","snippet":true},{"summary":false,"highlight":true,"property":"PriceOrign","snippet":true},{"summary":false,"highlight":true,"property":"Url","snippet":true},{"summary":false,"highlight":true,"property":"SourceUrl","snippet":true},{"summary":false,"highlight":true,"property":"Price","snippet":true},{"summary":false,"highlight":true,"property":"Discount","snippet":true},{"summary":false,"highlight":true,"property":"TimeEnd","snippet":true}]}
